= Travaux pratiques - Système de Contrôle de Version
Nicolas Frankel
:doctype: article
:encoding: utf-8
:lang: fr
:toc:
:toc-placement!:
:numbered:
:experimental:
:sectanchors:
:icons: font
:imagesdir: images/vcs

image::https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png[Licence Creative Commons, link="http://creativecommons.org/licenses/by-nc-sa/4.0/"]

Ce cours est mis à disposition selon les termes de la http://creativecommons.org/licenses/by-nc-sa/4.0/[Licence Creative Commons Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 4.0 International].

toc::[]

== Objectif

L'objectif de ce _workshop_ est de se familiariser avec Git, un système de contrôle de version distribué.

== Références

* https://git-scm.com/[Git - documentation officielle (EN)^]
* https://git-scm.com/book/fr/v2[Pro Git^]
* https://training.github.com/kit/downloads/github-git-cheat-sheet.pdf[Aide-mémoire Git (EN)^]
* http://zeroturnaround.com/wp-content/uploads/2016/02/Git-Cheat-Sheet.png[Un autre aide-mémoire Git Cheat Sheet (EN)^]
* http://liris.cnrs.fr/~pchampin/enseignement/intro-git[Introduction à Git^]
* https://www.atlassian.com/git/tutorials/[Tutorials Git par Atlassian (EN)^]
* https://try.github.io/[Apprentissage interactif (EN)^]

== Outillage

* https://www.sourcetreeapp.com/[SourceTree^]
* https://www.gitkraken.com/[Git Kraken^]

== Premiers pas avec Git

Cette section est dédiée au passage d'un projet sous Github.

NOTE: Github ne doit *pas* être confondu avec Git. Il s'agit uniquement d'une de ses implémentations (propriétaire). Il en https://bitbucket.org/[existe^] https://gitlab.com/users/sign_in[d'autres^]. Toutefois, Github reste le service Git le plus répandu actuellement, notamment grâce à son orientation sociale.

Les étapes à exécuter sont les suivantes :

=== Créer un compte Github

Cette étape est optionnelle si un compte Github est déjà existant. Dans le cas contraire, accéder au site https://github.com/[Github].

image::signup.png[Sign up]
    
Cliquer sur le bouton btn:[Sign up] pour créer un nouveau compte. Remplir les champs de manière adéquate.
    
image::join.png[Join Github]
    
Cliquer sur btn:[Create an account] Le plan sélectionné par défaut est gratuit ; il est suffisant dans le cadre de ce _workshop_. La limitation principale d'un tel plan est que tous les dépôts sont nécessairement publics et donc consultables par tous. Il est toujours possible d'en changer par la suite.
    
image::welcome.png[Welcome to Github]
    
Cliquer sur btn:[Finish sign up] pour terminer la création du compte. Bravo, le compte Github est maintenant créé.
    
image::learn.png[Learn Github]
    
Pour passer à l'étape suivante, il est avant tout nécessaire de valider l'adresse électronique : se référer au courriel qui a été envoyé.

=== Créer un dépôt sur Github

Un dépôt est un dépôt pour le code. En général, la cardinalité entre un dépôt et un projet est de 1 pour 1. On se contentera de ce cas général : un dépôt permettra de stocker les sources d'un unique projet.

Cliquer sur le bouton btn:[+ New repository] de l'écran précédent. Si un autre écran est affiché, il est possible de créer un nouveau dépôt à l'aide du bouton btn:[+] dans la barre de tâches affichée sur le site (une fois connecté).
    
Sélectionner un nom de projet et la description. Laisser les autres valeurs inchangées.
    
image::newrepo.png[Create a new repository]
    
Cliquer sur "Create repository".
    
image::setuprepo.png[Quick setup]

[[infos-utiles]]Conserver cette page ouverte, elle contient des informations utiles pour la suite.
    
Cette étape conclut la configuration de Github via l'interface graphique. La suite est identique quel que soit le fournisseur de service Git.

=== Initialiser un dépôt local

L'initialisation d'un dépôt git local se fait via la commande `init` :

[source, bash]
----
git init
----

Vérifier qu'après exécution de cette commande, un nouveau répertoire `.git` a été ajouté à la racine du répertoire dans lequel il a été exécuté. Notamment, regarder le contenu du fichier `.git/config` qui doit être similaire au contenu suivant :

[source]
.git/config
----
[core]
    repositoryformatversion = 0
    filemode = true
    bare = false
    logallrefupdates = true
    ignorecase = true
    precomposeunicode = true
----

=== Référencer un dépôt distant

Aller sur Github pour visualiser la link:#infos-utiles[page d'information]. Recherchez la section intitulée "...or push an existing repository from the command line".

L'exécution de la première ligne de commande permet de référencer le dépôt distant dans la configuration locale.

[source, bash]
----
git remote add origin git@github.com:user/repo.git
----

Dans le fichier `.git/config`, les lignes suivantes ont maintenant été ajoutées :

----
[remote "origin"]
        url = git@github.com:xxx/yyy.git
        fetch = +refs/heads/*:refs/remotes/origin/*
----

=== Gérer l'authentification

Chaque opération d'*écriture* dans le dépôt distant nécessite une authentification et l'autorisation en écriture - une vérification que l'utilisateur dispose de tels droits.

Dans la link:#trueajouter_le_d_p_t_distant[section précédente], l'URL ajoutée est de la forme `git@github.com:user/repo.git`.

Cette forme implique l'utilisation d'une communication SSH pour la synchronisation entre le dépôt local et le dépôt distant. L'authentification d'une telle communication se fait via un mécanisme asymétrique de type clé privé-clé publique.

[NOTE]
====
Si l'infrastructure décrite dans cette section se révèle trop lourde et qu'une authentification par login/mot de passe à **chaque** écriture est acceptable, utiliser plutôt HTTPS et une URL du type `https://github.com/user/repo.git`.
====

En fonction du système d'exploitation, voici la marche à suivre :

Pour Unix, Linux et Mac OSX::
La documentation est disponible https://docs.joyent.com/public-cloud/getting-started/ssh-keys/generating-an-ssh-key-manually/manually-generating-your-ssh-key-in-mac-os-x[ici (EN)]. [NOTE]
====
L'article mentionne Mac OS X mais est également applicable aux autres systèmes d'exploitation de type *Nix.
====
Pour Windows::
Il est d'abord nécessaire d'installer http://www.putty.org/[Putty]. La documentation est disponible https://docs.joyent.com/public-cloud/getting-started/ssh-keys/generating-an-ssh-key-manually/manually-generating-your-ssh-key-in-windows[ici (EN)].

Une fois la clé privée générée, il est nécessaire d'ajouter la clé publique dans votre compte Github. Pour cela, cliquer sur votre profil en haut à droite.

image::profileandmore.png[Menu]

Puis cliquer sur l'élémént https://github.com/settings/profile[Settings] du menu déroulant.

image::profile.png[Profil]

Enfin, dans le menu de gauche, cliquer sur l'élément SSH. Dans l'écran, cliquer sur le bouton btn:[New SSH Key]. Ajouter la clé publique.

image::sshkeys.png[SSH Keys]

=== Visualiser le statut des fichiers

Pour mémoire, le schéma suivant résume les états possibles dans git :
    
image:https://git-scm.com/images/about/index1@2x.png[Fig. 1 - Etats git]

Pour vérifier l'état des fichiers du dépôt local, utilisez la commande `status` :
    
[source, bash]
----
git status
----

Voici un exemple de sortie d'une telle commande :

....
On branch master

Initial commit

Untracked files:
  (use "git add <file>..." to include in what will be committed)

 .idea/
 pom.xml
 securitymanager-example.iml
 src/
 target/

nothing added to commit but untracked files present (use "git add" to track)
....

La liste exacte des fichiers est bien sûr dépendante du projet et de l'Atelier de Génie Logiciel (AGL) utilisé pour le développement.
    
=== Configurer les fichiers à exclure

Certains fichiers n'ont pas vocation à être gérés par le Système de Gestion de Version. Parmi ceux-ci, on recense les fichier générés (par exemple, les fichiers minifiés produits par Grunt et les fichiers `.class` produits la compilation Java), les fichiers de configuration de l'AGL, etc. 

Cette exclusion se base sur le contenu de fichiers `.gitignore` dans le dépôt. Dans le cadre de ces travaux pratiques, nous nous bornerons à l'utilisation d'un unique fichier de ce type situé à la *racine* du dépôt local.

Le format du fichier est basé sur des modèles d'exclusion, un modèle par ligne. L'intégralité des règle de formation des modèles est disponible dans la https://git-scm.com/docs/gitignore#_pattern_format[documentation officielle].

Par exemple, pour exclure les fichiers inutiles, le fichier `.gitignore` suivant peut être utilisé :

[source]
----
.idea
*.iml
target
----

La commande `status` renvoye alors un résultat différent du résultat précédent :

....
On branch master

Initial commit

Untracked files:
  (use "git add <file>..." to include in what will be committed)

.gitignore
pom.xml
src/

nothing added to commit but untracked files present (use "git add" to track)
....

=== Ajouter les fichiers à l'index

Avant de committer les fichiers, il est nécessaire de les ajouter comme le montre la figure 1 ci-dessus. L'ajout se fait à l'aide de la commande `add` qui prend en paramètre un modèle de chemin.
    
Le premier ajout incluant tous les fichiers, on peut en général utiliser le modèle `*` :

[source, bash]
----
git add *
----

Les modifications ultérieures de l'index se font généralement en ajoutant un fichier particulier. Il est nécessaire d'indiquer le chemin du (des) fichier(s) à ajouter :

[source, bash]
----
git add path/to/file
git add path/to/directory/*.java
git add *
----

=== Committer

Une fois les fichiers ajoutés à l'index, il est alors possible de committer le lot des fichiers. Cela est géré par la commande `commit`.

[source, bash]
----
git commit
----

[TIP]
====
La bonne granularité d'un commit est celle qui permet de revenir sur ce commit avec le minimum d'impacts.
====

=== Pousser les commits locaux

Dès lors qu'au moins un commit a été effectué dans le dépôt local, il est possible de pousser le(s) nouveau(x) commit(s) vers le dépôt distant. Cette action est possible via l'intermédiaire de la commande `push`:

[source, bash]
----
git push
----

[WARNING]
====
Il existe un risque que les arbres de travail locaux et distants soient désynchronisés - par exemple si quelqu'un d'autre a déjà poussé des commits sur le même dépôt distant. Pour le moment, ce risque est nul car il s'agit du premier commit.
====

== Pull requests

Dans la première sections, il a été décrit comment réaliser des commits et pousser ceux-ci vers le dépôt distant. L'objectif de cette seconde section est d'apprendre à réaliser des _pull requests_.

Pour cela, il est nécessaire de travailler en binôme. Si le nombre d'étudiants est impair, un groupe de trois travaillera en permutation circulaire.

=== Fork

La première étape pour réaliser une _pull request_ sur Github est de copier le dépôt de votre binôme dans votre propre compte. Allez sur l'URL du dépôt de votre binôme.

image::fork.png[Fork]

Cliquer sur le bouton btn:[Fork] en haut à droite pour copier le dépôt dans votre compte.

=== Cloner le dépôt

Maintenant qu'une copie du dépôt est associée à son propre compte, il est possible de le cloner en local en utilisant la commande `clone` :

[source, bash]
----
git clone url_du_depot
----

[NOTE]
====
Par rapport à `git init`, il n'est pas nécessaire d'ajouter un dépôt distant avec `git remote add`, la commande `clone` ajoute le paramétrage du dépôt distant à la configuration locale. 
====

=== Effectuer des modifications

Effectuer maintenant des modifications pertinentes sur le dépôt local copié. Réaliser un enchaînement d'opérations de `commit` et de `push` comme dans la link:#trueajouter_les_fichiers_l_index[section précédente].

=== Créer une pull request

La création de la _pull request_ elle-même s'effectue via l'interface graphique de Github. Naviguer vers la page de la *copie* du dépôt - celle qui est sur votre compte.

image::pullrequest.png[Créer une pull request]

Cliquer sur le bouton btn:[Pull Request] et suivre les instructions.

=== Traiter une pull request

Une fois que son binôme a effectué la _pull request_, aller sur son dépôt via l'interface graphique de Github. Regarder l'onglet Pull Request. Une pastille doit indiquer qu'il y a une _pull request_ en attente.

image::pullrequest2.png[Gérer une pull request]

Cliquer sur l'onglet. La liste des _pull request_ en attente de traitement s'affiche.

image::pullrequest3.png[Liste des pull request]

Cliquer sur la _pull request_. Le détail de la pull request s'affiche.

image::pullrequest4.png[Détail de la pull request]

Si les permissions sont suffisantes *et* qu'il n'existe pas de conflits, cliquer sur btn:[Merge Pull Request] pour fusionner l'intégralité des commits de la _pull request_ dans le dépôt.

== Récupération des commits distants

Jusqu'à présent, l'hypothèse implicite est qu'il n'y avait pas eu de commits sur le dépôt distant et que celui-ci était uniquement modifiés par ses propres _push_. Malheureusement, ce cas de figure idéal n'est rencontré que rarement.

=== Récupérer les commits distants - cas simple

La première étape consiste à récupérer les commits distants dans le cas où aucune modification locale n'a eu lieu.

Cela est effectuée à l'aide des commandes suivantes :

* `fetch` récupère les modifications distantes dans une branche locale temporaire (appelée `FETCH_HEAD`)
* il suffit alors d'utiliser la commande `merge` pour fusionner cette branche temporaire dans la branche courante

[source, bash]
----
git fetch
git merge
----

=== Récupérer les commits distantes - cas avancé

Dans le cas où des commits ont été effectués sur le dépôt local, le dernier des commits distants et locaux n'est plus le même. Git fusionne cette divergence automatiquement avec la commande `pull` lorsque c'est possible. Malheureusement, cela rend l'historique non linéaire.

image::https://gitmap.files.wordpress.com/2010/12/git-pull.png?w=620[git pull rebase]

Afin de réintégrer de manière linéaire l'ensemble des commits, Git permet d'appliquer en premier lieu les commits distants puis en second les commits locaux, en remontant jusqu'à l'ancêtre commun avec l'option `--rebase`.

image::https://gitmap.files.wordpress.com/2010/12/pull-rebase.png?w=620[git pull rebase]

Dans la vraie vie, il est conseillé d'exécuter la commande suivante dans tous les cas :

[source, bash]
----
git pull --rebase
----

Récupérer les commits effectuées sur votre dépôt distant via la _pull request_ dans la link:#truepull_requests[section précédente].

Ne pas oublier pas d'utiliser la commande `push` afin de pousser les commits locaux vers le dépôt distant après coup !

=== Gérer les conflits

Lorsqu'un conflit intervient lors de la fusion, Git l'indique sur la ligne de commande, avec la liste des fichiers qui comportent un tel conflit.

Il faut alors :

* Pour chaque fichier :
** Résoudre le conflit
** Ajouter le fichier ainsi modifié à l'index avec la commande `add`
* Exécuter la commande `commit` lorsque tous les conflits ont été résolus *et* tous les fichiers corrigés ajoutés à l'index

En accord avec son binôme, introduire des conflits entre les dépôts local et distant puis s'entraîner à les résoudre.

Ne pas oublier pas d'utiliser la commande `push` afin de pousser les commits locaux vers le dépôt distant après coup !